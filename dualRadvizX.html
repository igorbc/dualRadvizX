<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Dual Radviz</title>

    </head>

<!-- function called to initialize the system -->
    <body onload="startRadviz()">

    <div class="inputContainer">
        <label>Choose file to visualize</label>
        <br/>
        <input id="fileName" name="fileName" type="file" accept="text/csv,text/comma-separated-values,text/tab-separated-values,text/plain,.csv,.tsv"
        onchange="handleFile(this.files)"/>

    </div>
        <div style="margin:auto;">
            <div style="float:left; ">

                <div id="classContribSlider" style="margin:auto;">
                    <br/>

<!--  initial text above contribution slider -->
                    <h4 style="margin: 0 auto;"> <span id="contribution">Class: 0% / Attributes: 100%</span></h4>

                </div>

                <br/>
                <br/>
                <div id="chart"></div>
                <div id="attrCircles"></div>
                <div id="instanceCircles"></div>
            </div>
            <div id="sliderContainer" style="float:left; ">

                <br/>
                <div id="parc" class="parcoords" style="width:650px;height:350px; "></div >
            </div>
        </div>

<!--  inclusion of scripts -->
        <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script type="text/javascript" src="js/d3.slider.js"></script>
        <script type="text/javascript" src="js/d3extension.js"></script>
        <script type="text/javascript" src="js/d3.parcoords.js"></script>
        <script type="text/javascript" src="js/polybrush.js"></script>
        <!--  <script type="text/javascript" src="js/numeric-1.2.6.min.js"></script> -->

        <script type="text/javascript" src="js/setupAssistent.js"></script>
        <script type="text/javascript" src="js/avap.js"></script>
        <script type="text/javascript" src="js/avapContainer.js"></script>
        <script type="text/javascript" src="js/vizContainer.js"></script>
        <script type="text/javascript" src="js/legend.js"></script>
        <script type="text/javascript" src="js/dragManager.js"></script>
        <script type="text/javascript" src="js/tooltipManager.js"></script>
        <script type="text/javascript" src="js/loadFile.js"></script>
        <script type="text/javascript" src="js/vec.js"></script>

<!-- inclusion of styles -->
        <link rel="stylesheet" href="stylesheets/d3.parcoords.css" />
        <link rel="stylesheet" href="stylesheets/d3.slider.css" />
        <link rel="stylesheet" href="stylesheets/styles.css" />

        <script>
            var sa = new SetupAssistent();
            var vc = new VizContainer();

            var headersAttr = [];

            var classIndex;

            var headersClass = [];
            var classNames = [];
            var parcoords;
            var csv;
            var contribSlider;
            var radviz = false;
            var colorAll = true;
            var PI = Math.PI;
            var TWO_PI = PI * 2;
            var shitfPressed = false;
            var rotAngle = 5;
            var delay = 800;

            var color = sa.getClassColorScheme();
            svgContainer = sa.getSvgContainer();

            function startRadviz(fileName) {

                if(fileName == undefined) {
                    fileName = sa.defaultFile;
                }

                vc.createAcApContainers();

                console.log(fileName);

                d3.csv(fileName, function (csv) {
                    var headers = sa.getAttrAndClassHeaders(csv);
                    headersAttr = headers[0];
                    headersClass = headers[1];
                    classNames = sa.getClassNames(headersClass);

                    sa.setupBrush(csv, svgContainer, vc.acAttr);

                    vc.acAttr.initializeAvApInfo(headersAttr, csv);
                    vc.acClass.initializeAvApInfo(headersClass, csv, classNames, color);

                    if(vc.isRadviz){
                        vc.acAttr.createPath(delay);
                        vc.acClass.createPath(delay);
                    }
                    else{
                        vc.acAttr.createStarCoordLines();
                        vc.acClass.createStarCoordLines();
                    }
                    vc.initializeInstGroup(csv);
                    vc.acClass.createAvApGroup();
                    vc.acAttr.createAvApGroup();
                    vc.acClass.rotate(-TWO_PI/headersAttr.length);

                    vc.updateInst(delay);

                    csv = csv.map(function (d) {
                        d.mouseOver = "false";
                        return d;
                    });

                    setupTooltip(headersAttr, headersClass, csv);

                    addSvgLegend(classNames, svgContainer);
                    setupDragBehaviour(vc.acAttr, vc.acClass);

                    if (contribSlider == undefined) {
                        contribSlider = d3.slider().min(-100).max(100).value(100)
                                .on("slide", function (evt, value) {
                                    vc.acClass.contribution = 1 - value / 100;
                                    vc.acAttr.contribution = 1 + value / 100;

                                    var cContr = vc.acClass.contribution / (vc.acClass.contribution + vc.acAttr.contribution);
                                    var aContr = vc.acAttr.contribution / (vc.acClass.contribution + vc.acAttr.contribution);

                                    vc.acAttr.normalizedContribution = aContr;
                                    vc.acClass.normalizedContribution = cContr;

                                    d3.select("#contribution")
                                            .text("Class: " + Math.round(cContr * 100) + "% / Attributes: " + Math.round(aContr * 100) + "%");

                                    /*
                                    if(vc.acAttr.normalizedContribution > 0.5){
                                        vc.acAttr.bringAvApsToFront();
                                    }
                                    else{
                                        vc.acClass.bringAvApsToFront();
*/
                                    vc.acAttr.updateAvApPositionOnScreen();
                                    vc.acClass.updateAvApPositionOnScreen();
                                    vc.updateInst();
                                });

                        d3.select("#classContribSlider").call(contribSlider);
                    }

                    // saves the state of Shift key
                    d3.select("body")
                            .on("keydown", function () {
                                shitfPressed = d3.event.shiftKey;
                                d3.event.preventDefault();
                                switch(d3.event.code){
                                    case "KeyC":
                                        vc.acAttr.instGroup.selectAll(".selected").classed("selected", false);
                                        console.log("c");
                                        break;

                                    case "ArrowLeft":
                                        if(!vc.isRadviz){
                                            if(!d3.event.altKey)
                                                vc.acAttr.rotate(deg2rad(rotAngle), "y");
                                            if(!d3.event.shiftKey)
                                                vc.acClass.rotate(deg2rad(rotAngle), "y");
                                        }
                                        break;

                                    case "ArrowRight":
                                        if(!vc.isRadviz){
                                            if(!d3.event.altKey)
                                                vc.acAttr.rotate(deg2rad(-rotAngle), "y");
                                            if(!d3.event.shiftKey)
                                                vc.acClass.rotate(deg2rad(-rotAngle), "y");
                                        }
                                        break;
                                    case "ArrowUp":
                                        if(!vc.isRadviz){
                                            if(!d3.event.altKey)
                                                vc.acAttr.rotate(deg2rad(rotAngle), "x");
                                            if(!d3.event.shiftKey)
                                                vc.acClass.rotate(deg2rad(rotAngle), "x");
                                        }
                                        /*
                                        else{
                                            vc.acAttr.r+=2;
                                            vc.acAttr.updatePath();
                                            vc.acAttr.alignAvApsWithRadviz();
                                            vc.acAttr.updateAvApPositionOnScreen();
                                            vc.updateInst();
                                        }
                                        */
                                        break;

                                    case "ArrowDown":
                                        if(!vc.isRadviz){
                                            if(!d3.event.altKey)
                                                vc.acAttr.rotate(deg2rad(-rotAngle), "x");
                                            if(!d3.event.shiftKey)
                                                vc.acClass.rotate(deg2rad(-rotAngle), "x");
                                        }
                                        break;
                                    case "KeyR":
                                        vc.toggleRvSc();
                                        break;
                                    /*
                                    case "":
                                        rotAngle+=5;
                                        console.log("rot angle: " + rotAngle);

                                    case "":
                                        rotAngle-=5;
                                        console.log("rot angle: " + rotAngle);
                                    */
                                }
                            })
                            .on("keyup", function () {
                                shitfPressed = d3.event.shiftKey;
                            })


                });

            }
        </script>
    </body>
</html>
